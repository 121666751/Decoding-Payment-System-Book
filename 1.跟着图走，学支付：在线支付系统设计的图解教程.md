_这是《百图解码支付系统设计与实现》专栏系列文章中的第（1）篇。_
_本系列文章是偏实战的，本章内容讲清楚支付系统是什么，主要解决什么问题，部分核心流程，以及一些后面会频繁使用到的术语。至于支付起源，在线支付发展历程等知识，感兴趣的同学可以参考网络上其它文章或书籍。_

# 基本概念
下面描述的概念大部分做了极致简化，只是用于入门，对于理解概念应该是够用的。真实的实现会复杂非常多，后面的系列文章会展开做详细说明。
> _后面的描述中，经常混着用“支付系统”、“支付平台”，本质是一个东西。在内部来说，就是一个支付系统，但从和外部机构交互来说，就是一个支付平台。_

## 最简支付流程
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703335982533-390af531-9f80-4a62-a2c8-548ff8a810a4.png#averageHue=%23f7f7f7&clientId=u3051da84-fb79-4&from=paste&height=508&id=ub69772bc&originHeight=1015&originWidth=1928&originalType=binary&ratio=2&rotation=0&showTitle=false&size=192101&status=done&style=none&taskId=u4f5d5580-55de-42fd-be67-eeaf1224422&title=&width=964)
说明：

1. 这是一个最简化的支付流程。真实的交互比这个复杂得多，单收银台渲染就可以写一整篇文章。但对于讲清楚支付系统的作用，已经足够。
2. 从图中可以引申出**支付系统最核心的作用：帮商户收钱**。
3. 有支付当然就有退款、撤销等逆向操作，复杂的跨境支付还会有外汇交易，跨境结算等业务。这些全部在后面的系列文章中细讲。

## 最简清结算流程
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703396539992-1b0d974f-7f93-4e7d-a9d5-7d412ee92ac4.png#averageHue=%23f6f6f6&clientId=u6f493bfd-73e1-4&from=paste&height=508&id=ufcc4cb21&originHeight=1015&originWidth=1304&originalType=binary&ratio=2&rotation=0&showTitle=false&size=129506&status=done&style=none&taskId=u9a399d3a-1cb2-40c1-aebc-168ae210071&title=&width=652)
说明：

1. 这里画的是信息流。
2. 银行和支付平台之间是机构对机构的关系，通常使用清算概念，因为金融机构之间大部分情况下会有独立的清算机构做清算服务。
3. 支付平台和商户之间，通常使用结算概念，由支付平台直接打款给商户。
4. 上面画的是结算到商户开在支付平台的内部账户余额，所以需要商户手动提现，支付平台通常也支持直接结算到卡，这样就不需要商户手动提现。
5. 清结算三个字还有另外一层含义：清分 + 结算。前者是把钱算清楚，后者是真实打款。


## 最简本对本收单流程
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703397087656-78dd25b8-abd2-4aa2-8429-4475dd54bfd2.png#averageHue=%23f8f8f8&clientId=u6f493bfd-73e1-4&from=paste&height=443&id=u1e53f46a&originHeight=886&originWidth=1985&originalType=binary&ratio=2&rotation=0&showTitle=false&size=122544&status=done&style=none&taskId=u09eb04e4-2898-413b-b586-4099a4695bc&title=&width=992.5)
说明：

1. 所谓本对本收单，就是指商户的商品标价币种、向支付系统的下单币种、用户支付币种、商户结算币种都是同一个币种。不涉及到外汇交易。
2. 一个中国人拿着中国招商银行信用卡在淘宝或京东买东西，就是标准的本对本收单。


## 最简跨境收单流程
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703405828666-c518c65e-92f9-4da1-b263-cbf104be14fb.png#averageHue=%23f5f5f5&clientId=u6f493bfd-73e1-4&from=paste&height=443&id=u31fbc828&originHeight=886&originWidth=2006&originalType=binary&ratio=2&rotation=0&showTitle=false&size=182646&status=done&style=none&taskId=ua5c7157a-4d32-4c4e-b498-39e3c09a880&title=&width=1003)
说明：

1. 所谓跨境收单，就是结算给商户的币种和用户支付的币种不一样，需要经过外汇机构换汇。
2. 在扣款EUR成功后，支付平台会调用外部的外汇机构进行锁汇（HA）。
3. 在银行清算后，支付平台再调用外部的外汇机构进行真正的换汇（TA）。
4. 最后支付平台结算给商户USD。

如果换成时序图，如下：
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703336876738-3851ab31-87f1-4468-acaa-272930b53144.png#averageHue=%23f6f6f6&clientId=u3051da84-fb79-4&from=paste&height=961&id=u68c27de9&originHeight=1922&originWidth=2121&originalType=binary&ratio=2&rotation=0&showTitle=false&size=281710&status=done&style=none&taskId=u5cb50eb8-0a69-40ab-9148-0eec232f96e&title=&width=1060.5)

## 最简信息流与资金流
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703336902364-1d9fd8e7-52c6-4693-b4c2-66bfef8e3fd3.png#averageHue=%23f5f1f1&clientId=u3051da84-fb79-4&from=paste&height=486&id=udf17492b&originHeight=971&originWidth=2118&originalType=binary&ratio=2&rotation=0&showTitle=false&size=224387&status=done&style=none&taskId=ua44e30cf-efc0-45a3-8587-6d744b94fbf&title=&width=1059)
说明：

1. 用户在支付平台充值10元，支付平台向银行发起扣款请求，这些指令操作归属于信息交互，属于信息流。
2. 真实资金流：银行账户余额的变动。比如：银行在内部把用户的余额减10元，给支付平台备付金账户加10元。
3. 虚拟资金流：支付平台内部账户余额的变动。比如：支付平台内部把银行应收账户加10元，给用户余额账户加10元。
4. 为什么会有真实资金流和虚拟资金流之分？因为我们真正能拿到钱的地方是银行，在支付系统内看到的只是一个数字，如果想变成真实世界的钱，还得发给银行提现。

## 跨境收单的协议关系
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703336944651-e48fcbbb-f676-4313-a516-5d5a35e515e1.png#averageHue=%23f8f8f8&clientId=u3051da84-fb79-4&from=paste&height=852&id=u0e8652e8&originHeight=1704&originWidth=1881&originalType=binary&ratio=2&rotation=0&showTitle=false&size=241381&status=done&style=none&taskId=u568c4b5e-4fc9-4b10-8c14-b34753cf50a&title=&width=940.5)
说明：

1. 这只是跨境收单的一种协议关系，真实场景存在多种形态。
2. 上述的收单机构是持牌的，但是没有跨境结算的能力，所以需要委托有跨境结算牌照的金融机构代为处理跨境结算业务。
3. 跨境电商平台只是一个商户平台，没有收单资质，所以需要委托收单机构给它下面的供应商结算打款。
4. 剩下的协议关系都是一目了然的，只是我们日常没有注意。比如用户和电商平台之间在注册时就会有会员协议要签署。
5. 特殊的情况下，一些实力雄厚的机构，比如蚂蚁或财付通，下面会成立多个实体（不同的法律主体），然后用不同的实体去申请不同的牌照（收单、银行、外汇、跨境代发等），这样表面上全部是一家公司搞定，但是实际的协议关系仍然是上面这样的，在各实体之间仍然需要签署各种协议。
6. 如果是本对本收单场景就简单很多，没有外汇和跨境结算这一层关系，如果跨境电商的货品全部是电商实体自营的，那就更简单，没有供应商委托结算的协议。
7. 一般电商平台在没有牌照情况下是不能开设余额账户的，如果电商想开通余额，可以委托第三方有牌照的公司托管（通常也是收单机构，收单机构一般会同时申请PA、PG牌照），这种情况下，电商平台和收单机构还会签署账户委托协议。

## 跨境资金方案
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703407726206-9b63fa39-8102-4398-8bba-9210f4bd515e.png#averageHue=%23f6f6f6&clientId=u6f493bfd-73e1-4&from=paste&height=573&id=ubc849ff5&originHeight=1145&originWidth=3205&originalType=binary&ratio=2&rotation=0&showTitle=false&size=295663&status=done&style=none&taskId=u1deb97f7-aaff-4a48-a6cb-3965bceb9c0&title=&width=1602.5)
说明：

1. 这是一个典型的跨境资金流案例。用户支付USD，收单机构收到的是USD，但是需要结算RMB给中国境内的商户。
2. 收单机构（也就是支付平台）需要先将USD兑换成CNH（离岸人民币），再由入境代发机构把RMB结算给中国境内商户。这是所谓的“结汇入境”。
3. 如果采用“入境结汇”的方式，则收单机构直接结算USD给商户在境外的银行账户中，由商户以USD汇入境内，再兑换成RMB。或者收单机构先把USD汇入境内备付金账户，再兑换成RMB，然后再结算RMB给中国境内商户。
4. 以上这些不同的资金处理方案，统称为资金方案。

## 简明复式记账
金融机构的记账一定是基于复式记账法。下面以用户通过支付平台使用银行支付500块为例做个简要说明。
假设：支付平台使用CMB做为收单行，在CMB开设有备付金账户。
涉及的支付平台内部账户：

| **账户类型** | **账户** | **备注** |
| --- | --- | --- |
| 借记账户 | 应收-渠道-CMB | 应收归属借记账户 |
| 贷记账户 | 应付-过渡-网关过渡户
应付-平台托管-商户待结算
应付-平台托管-商户余额
手续费收入-商户-消费 | 应付归属贷记账户
手续费意味着所有者权益增加，归属贷记账户 |

记账步骤：

| **阶段** | **操作账户** | **金额** |
| --- | --- | --- |
| 第一步
资金从渠道到网关过渡户 | 借：应收-渠道-CMB
贷：应付-过渡-网关过渡户 | 500 |
| 第二步
扣除手续费 | 借：应付-过渡-网关过渡户
贷：手续费收入-商户-消费 | 10 |
| 第三步
网关过渡户到商户待结算账户 | 借：应付-过渡-网关过渡户
贷：应付-平台托管-商户待结算 | 490 |
| 第四步
结算给商户 | 借：应付-平台托管-商户待结算
贷：应付-平台托管-商户余额 | 490 |

说明：

1. 支付系统的记账一定是复式记账法。内部开设了很多账户和科目。
> _【借记类】账户：资产，应收款等；_
> _【贷记类】账户：负债，所有者权益，应付款等；_

2. 借贷简要公式（不太严谨，但是够用）：
> _【借记类】账户（如资产，应收款），【增加】为【借】，【减少】为【贷】；_
> _【贷记类】账户（如负债和所有者权益，应付款），【增加】为【贷】，【减少】为【借】；_

3. 复式记账的专业书籍很多，这里只摘录几个重要的说明：
> _复式记账法定义：对每项经济业务按相等的金额在两个或两个以上有关账户中同时进行登记的方法。_
> _记账原则：有借必有贷，借贷必相等。_
> _记账依据：会计恒等式：1. 资产 = 负债 + 所有者权益；2. 利润 = 收入 - 费用。_
> _账户：具有一定格式和结构，能够用来连续、系统、全面的记录反映某种经济业务的增减变化及其结果。_
> _科目：同类财务交易的分类，比如资产、负债、所有者权限、收入或费用等都属于科目。一般科目会分为多级。_
> _账户和科目的区别：科目只有名字，账户包括结构和格式，每个账户对应一个特定的科目。_



# 概要设计
## 简明产品架构图
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703409160751-7452dfa9-5c96-47c0-9e2c-1d68612616da.png#averageHue=%23dddddd&clientId=u6f493bfd-73e1-4&from=paste&height=730&id=u5a88a77c&originHeight=1459&originWidth=1740&originalType=binary&ratio=2&rotation=0&showTitle=false&size=435392&status=done&style=none&taskId=u9f23a381-1dea-4e0b-b552-ac7a96d1577&title=&width=870)
说明：

1. 这个图画得比较简单，但是已经涵养一个支付系统最核心的产品能力。
2. 上面部分是会员或商户感知的产品能力，包括门户、收银台，收单产品，资金产品等。下面部分是支付系统最核心的服务，用于支撑对外的产品能力。

## 极简支付系统架构图
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703343143594-b37f1715-2720-4a54-91c1-8b051063bb15.png#averageHue=%23a4bbd1&clientId=u3051da84-fb79-4&from=paste&height=328&id=u8af4c554&originHeight=656&originWidth=1426&originalType=binary&ratio=2&rotation=0&showTitle=false&size=137870&status=done&style=none&taskId=u25419733-0626-4fbc-80ac-e83cd6cbb89&title=&width=713)
说明：

1. 这个图很精简，但是基本已经够用，应付本对本交易这种简单的业务是完全没有问题的。
2. 一些复杂的支付系统可能还有外汇、额度中心、产品中心、卡中心等，甚至一个子系统可能会拆分为多个应用独立部署，比如收单结算就可以拆成收单和结算两个独立的应用。

## 完整支付系统架构图及各子系统简介
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703342911802-3e8feedc-a55e-4b3c-9b35-da4aa14dc953.png#averageHue=%23dedede&clientId=u3051da84-fb79-4&from=paste&height=932&id=u9bc64b00&originHeight=1864&originWidth=2978&originalType=binary&ratio=2&rotation=0&showTitle=false&size=853067&status=done&style=none&taskId=u1334aa1a-8c14-4a6d-9c1f-9da0e466d94&title=&width=1489)
说明：

1. 这是一比较完整的系统架构图，属于逻辑划分。在单体应用中，就是一些模块，在分布式应用中，就是一些子域、子应用或子系统。
2. 以下是各子系统简单介绍：
   1. **开放网关**：主要对接商户，比如下单、支付等接口入口。通常要求有比较高的安全性。部分公司可能会把移动端网关、PC门户网关、商户通知等能力集成在开放网关，也可能会单独拆出部署。
   2. **收单结算**：负责把商户的单收下来，并给商户发起结算。承担的收单产品包括有：线上收单，线下收单，担保交易、即时到账等，每个公司的商业策略不同，开出的收单产品会有差异。
   3. **资金产品**：承担无买卖标的的纯资金转移能力。典型的有：充值、转账、提现、代发。和支付的区分在于支付是有买卖标的，而资金产品没有。也就是在系统中没有买卖记录发生，但在线下可能有。
   4. **收银核心**：渲染可用支付方式。包括查询账户是否有余额，查询营销是否有营销券，查询渠道网关是否有可用的外部渠道，最后组合成可用支付方式，供前端渲染。
   5. **支付引擎**：负责真正的扣款或转账。有些公司叫支付核心，或资产交换。个人认为资产交换更合适，因为无论对于支付、退款、充值、转账等各种交易，本质都是把资产从一个账户交换到另外一个账户。
   6. **渠道网关**：负责去外部渠道扣款。通常还会提供渠道路由、渠道咨询等能力，做得细的公司可能下面再细分为渠道产品，报文网关和文件网关。
   7. **会员平台**：管理会员的注册、登录、密码、实名认证等。
   8. **商户平台**：管理商户的入驻、登录、交易管理等。
   9. **产品中心**：管理平台对外提供的产品能力。一般大的支付系统才会独立成一个子系统。
   10. **资金账务**：负责账户开立，记账等。
   11. **会计中心**：会计科目管理、分录管理、日切管理。
   12. **对账中心**：负责明细对账和资金对账。
   13. **营销平台**：提供满减、红包等营销工具。
   14. **风控平台**：针对账户和交易，提供实时、离线风控，控制平台的风险。
   15. **运营平台**：订单管理、渠道管理、产品管理等综合运营工具。
   16. **数据平台**：主要用于数据汇总和分析。分布式部署后，数据都在各子系统中，需要汇总到数据平台用于经营分析。
   17. **卡中心**：负责管理用户的绑卡信息。需要经过PCI认证。
   18. **额度中心**：累计用户、商户的额度，通常有日、月、年等各种分类。
   19. **外汇平台**：负责外汇报价和兑换。
   20. **流动性与调拨中心**：一些跨境支付公司，在多个国家多个银行有头寸，各头寸之间经常需要做流动性管理，提高资金利用率。
   21. **差错中心**：负责差错处理。比如渠道退款失败，需要通过其它的方式退给用户。
   22. **拒付中心**：处理用户的拒付和举证。在跨境支付场景下，信用卡用户联系发卡行说卡被盗刷或商品没有收到，或商品有问题等，拒绝支付给商户。

## 核心系统依赖图
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40836343/1703343867975-6b3341a1-0159-4667-aa19-5f21675eb4b4.png#averageHue=%23c5def2&clientId=u3051da84-fb79-4&from=paste&height=936&id=u0fb231e8&originHeight=1872&originWidth=2128&originalType=binary&ratio=2&rotation=0&showTitle=false&size=486323&status=done&style=none&taskId=u2e31088a-f5da-4cca-9b81-40daa155400&title=&width=1064)
说明：

1. 图中画得比较清楚了，没有太多需要补充的。
2. 其中红色线为支付主链路。

# 常见术语索引
参考“传送门”中的“支付行业黑话：支付系统必知术语一网打尽”篇章。

# 结束语
本章主要讲了一些支付相关的基本概念，支付系统的概要设计框图，部分核心流程，以及一些常见的术语，让同学对支付系统有一个整体的理解。
下一章节将围绕面向商户的收单和结算，请清楚如何给商户收单，又是如何结算给商户的。

微信加作者：
![WechatIMG3.jpg](https://cdn.nlark.com/yuque/0/2024/jpeg/40836343/1705153460140-ae2d7a0d-69b1-4113-b4f5-4c8cc0057dbb.jpeg#averageHue=%233c62c3&clientId=u708b9fae-576b-4&from=ui&height=292&id=RBhK6&originHeight=940&originWidth=686&originalType=binary&ratio=2&rotation=0&showTitle=false&size=153214&status=done&style=none&taskId=uc31ffa65-6bf9-40b9-9f06-fc3628af24b&title=&width=213)

关注微信公众号：
![扫码_搜索联合传播样式-白色版.png](https://cdn.nlark.com/yuque/0/2024/png/40836343/1705153520799-47c325d2-52f5-4336-9c57-3e6c212de74c.png#averageHue=%23e7e7e7&clientId=u708b9fae-576b-4&from=ui&id=u9f5fdc61&originHeight=624&originWidth=1710&originalType=binary&ratio=2&rotation=0&showTitle=false&size=138539&status=done&style=none&taskId=ua8a840f9-a679-46b5-9c67-c37d42dc52d&title=)



